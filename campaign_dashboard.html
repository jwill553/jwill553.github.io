<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DnD Campaign Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b5cf6;
            --secondary: #ec4899;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ally: #22c55e;
            --neutral: #eab308;
            --hostile: #dc2626;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: 'üêâ';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 100px;
            opacity: 0.1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .header-stat {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .header-stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .header-stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5em;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .quest-item {
            background: rgba(139, 92, 246, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quest-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .priority-high {
            background: var(--danger);
            color: white;
        }

        .priority-medium {
            background: var(--warning);
            color: white;
        }

        .priority-low {
            background: var(--success);
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
        }

        .npc-list {
            display: grid;
            gap: 10px;
        }

        .npc-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 4px solid;
            transition: background 0.3s;
        }

        .npc-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .npc-ally {
            border-left-color: var(--ally);
        }

        .npc-neutral {
            border-left-color: var(--neutral);
        }

        .npc-hostile {
            border-left-color: var(--hostile);
        }

        .npc-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .npc-info {
            flex: 1;
        }

        .npc-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .npc-role {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .session-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .session-timeline::-webkit-scrollbar {
            width: 8px;
        }

        .session-timeline::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .session-timeline::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            position: relative;
        }

        .timeline-marker {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-date {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: var(--text-muted);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .setup-instructions {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .setup-instructions h3 {
            margin-bottom: 10px;
            color: var(--success);
        }

        .setup-instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-instructions code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--secondary);
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            z-index: 1000;
        }

        .party-member {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .party-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
        }

        .party-info {
            flex: 1;
        }

        .party-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 3px;
        }

        .party-class {
            color: var(--text-muted);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Instructions (shown until configured) -->
        <div id="setupInstructions" class="setup-instructions">
            <h3>üîß Setup Required: Connect to Google Sheets</h3>
            <ol>
                <li>Open your Campaign Tracker Google Sheet</li>
                <li>Click <strong>Extensions ‚Üí Apps Script</strong></li>
                <li>Create a new script and paste the deployment code (see console)</li>
                <li>Deploy as Web App (Anyone with link can access)</li>
                <li>Copy the Web App URL and paste it below</li>
            </ol>
            <input type="text" id="sheetUrlInput" placeholder="Paste your Google Sheets Web App URL here" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
            <button onclick="saveSheetUrl()">Connect to Sheet</button>
        </div>

        <!-- Main Dashboard Header -->
        <div class="header">
            <h1 id="campaignName">Campaign Dashboard</h1>
            <p id="campaignArc">Loading campaign data...</p>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-label">Total Sessions</div>
                    <div class="header-stat-value" id="totalSessions">-</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Party Level</div>
                    <div class="header-stat-value" id="partyLevel">-</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Total XP Awarded</div>
                    <div class="header-stat-value" id="totalXP">-</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Party Gold</div>
                    <div class="header-stat-value" id="partyGold">-</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid">
            <!-- Active Quests -->
            <div class="card full-width">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üéØ</span>
                        Active Quests
                    </div>
                </div>
                <div id="questList">
                    <div class="loading">Loading quests...</div>
                </div>
            </div>

            <!-- NPCs -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üë•</span>
                        Notable NPCs
                    </div>
                </div>
                <div id="npcList" class="npc-list">
                    <div class="loading">Loading NPCs...</div>
                </div>
            </div>

            <!-- Campaign Stats -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üìä</span>
                        Campaign Stats
                    </div>
                </div>
                <div class="stat-grid" id="statsGrid">
                    <div class="stat-item">
                        <div class="stat-value" id="npcCount">-</div>
                        <div class="stat-label">NPCs Met</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="questCount">-</div>
                        <div class="stat-label">Active Quests</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="allyCount">-</div>
                        <div class="stat-label">Allies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="enemyCount">-</div>
                        <div class="stat-label">Enemies</div>
                    </div>
                </div>
            </div>

            <!-- Recent Sessions -->
            <div class="card full-width">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üìÖ</span>
                        Recent Sessions
                    </div>
                </div>
                <div id="sessionTimeline" class="session-timeline">
                    <div class="loading">Loading sessions...</div>
                </div>
            </div>

            <!-- XP Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üìà</span>
                        XP Progress
                    </div>
                </div>
                <canvas id="xpChart"></canvas>
            </div>

            <!-- NPC Relationship Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ü§ù</span>
                        NPC Relationships
                    </div>
                </div>
                <canvas id="npcChart"></canvas>
            </div>
        </div>

        <!-- Refresh Button -->
        <button class="refresh-btn" onclick="loadDashboard()" title="Refresh Data">üîÑ</button>
    </div>

    <script>
        // Configuration
        let SHEET_URL = localStorage.getItem('sheetUrl') || '';
        
        // Check if setup is needed
        if (!SHEET_URL) {
            document.getElementById('setupInstructions').style.display = 'block';
        } else {
            document.getElementById('setupInstructions').style.display = 'none';
            loadDashboard();
        }

        function saveSheetUrl() {
            const url = document.getElementById('sheetUrlInput').value.trim();
            if (url) {
                localStorage.setItem('sheetUrl', url);
                SHEET_URL = url;
                document.getElementById('setupInstructions').style.display = 'none';
                loadDashboard();
            } else {
                alert('Please enter a valid URL');
            }
        }

        // Sample data for demonstration (will be replaced by Google Sheets data)
        const sampleData = {
            campaign: {
                name: "The Crimson Prophecy",
                arc: "Chapter 2: Shadows of the North",
                level: 7,
                sessions: 15
            },
            sessions: [
                { number: 15, title: "The Frozen Tomb", date: "2024-10-01", xp: 3500 },
                { number: 14, title: "Betrayal at Blackwater", date: "2024-09-24", xp: 3200 },
                { number: 13, title: "The Council's Decision", date: "2024-09-17", xp: 2800 },
                { number: 12, title: "Rescue Mission", date: "2024-09-10", xp: 3800 },
                { number: 11, title: "Into the Underdark", date: "2024-09-03", xp: 3400 }
            ],
            quests: [
                { name: "Stop the Lich King", status: "Active", priority: "High", progress: 65 },
                { name: "Find the Lost Artifact", status: "Active", priority: "High", progress: 40 },
                { name: "Rescue the Prisoners", status: "Active", priority: "Medium", progress: 80 },
                { name: "Investigate the Cult", status: "Active", priority: "Low", progress: 25 }
            ],
            npcs: [
                { name: "Thorin Ironforge", role: "Dwarven King", relationship: "Ally", avatar: "üëë" },
                { name: "Malachar the Dark", role: "Lich Lord", relationship: "Hostile", avatar: "üíÄ" },
                { name: "Elara Moonwhisper", role: "Elven Mage", relationship: "Ally", avatar: "üßô‚Äç‚ôÄÔ∏è" },
                { name: "Grimjaw", role: "Orc Warlord", relationship: "Hostile", avatar: "‚öîÔ∏è" },
                { name: "Bartok the Merchant", role: "Trader", relationship: "Neutral", avatar: "üí∞" }
            ],
            gold: 4850,
            totalXP: 48500
        };

        async function loadDashboard() {
            try {
                // In production, this would fetch from Google Sheets
                // For now, using sample data
                const data = await fetchGoogleSheetData() || sampleData;
                
                renderDashboard(data);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load campaign data. Using sample data.');
                renderDashboard(sampleData);
            }
        }

        async function fetchGoogleSheetData() {
            if (!SHEET_URL) return null;
            
            try {
                const response = await fetch(SHEET_URL);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching from Google Sheets:', error);
                return null;
            }
        }

        function renderDashboard(data) {
            // Update header
            document.getElementById('campaignName').textContent = data.campaign.name;
            document.getElementById('campaignArc').textContent = data.campaign.arc;
            document.getElementById('totalSessions').textContent = data.campaign.sessions;
            document.getElementById('partyLevel').textContent = data.campaign.level;
            document.getElementById('totalXP').textContent = data.totalXP.toLocaleString();
            document.getElementById('partyGold').textContent = data.gold + ' GP';

            // Render quests
            renderQuests(data.quests);

            // Render NPCs
            renderNPCs(data.npcs);

            // Update stats
            updateStats(data);

            // Render sessions
            renderSessions(data.sessions);

            // Render charts
            renderXPChart(data.sessions);
            renderNPCChart(data.npcs);
        }

        function renderQuests(quests) {
            const container = document.getElementById('questList');
            container.innerHTML = quests.map(quest => `
                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-name">${quest.name}</div>
                        <span class="priority-badge priority-${quest.priority.toLowerCase()}">${quest.priority}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${quest.progress}%"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9em; color: var(--text-muted);">${quest.progress}% Complete</div>
                </div>
            `).join('');
        }

        function renderNPCs(npcs) {
            const container = document.getElementById('npcList');
            container.innerHTML = npcs.slice(0, 5).map(npc => `
                <div class="npc-item npc-${npc.relationship.toLowerCase()}">
                    <div class="npc-avatar">${npc.avatar}</div>
                    <div class="npc-info">
                        <div class="npc-name">${npc.name}</div>
                        <div class="npc-role">${npc.role} ‚Ä¢ ${npc.relationship}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats(data) {
            document.getElementById('npcCount').textContent = data.npcs.length;
            document.getElementById('questCount').textContent = data.quests.length;
            document.getElementById('allyCount').textContent = data.npcs.filter(n => n.relationship === 'Ally').length;
            document.getElementById('enemyCount').textContent = data.npcs.filter(n => n.relationship === 'Hostile').length;
        }

        function renderSessions(sessions) {
            const container = document.getElementById('sessionTimeline');
            container.innerHTML = sessions.map(session => `
                <div class="timeline-item">
                    <div class="timeline-marker">${session.number}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${session.title}</div>
                        <div class="timeline-date">${session.date} ‚Ä¢ ${session.xp} XP</div>
                    </div>
                </div>
            `).join('');
        }

        function renderXPChart(sessions) {
            const ctx = document.getElementById('xpChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sessions.map(s => `Session ${s.number}`),
                    datasets: [{
                        label: 'XP Awarded',
                        data: sessions.map(s => s.xp),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderNPCChart(npcs) {
            const ctx = document.getElementById('npcChart').getContext('2d');
            const relationships = {
                Ally: npcs.filter(n => n.relationship === 'Ally').length,
                Neutral: npcs.filter(n => n.relationship === 'Neutral').length,
                Hostile: npcs.filter(n => n.relationship === 'Hostile').length
            };

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Allies', 'Neutral', 'Hostile'],
                    datasets: [{
                        data: [relationships.Ally, relationships.Neutral, relationships.Hostile],
                        backgroundColor: ['#22c55e', '#eab308', '#dc2626'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#f1f5f9', padding: 15 }
                        }
                    }
                }
            });
        }

        function showError(message) {
            console.error(message);
        }

        // Print setup instructions to console
        console.log(`
%cüé≤ DnD Campaign Dashboard Setup Instructions

%cTo connect this dashboard to your Google Sheets Campaign Tracker:

1. Open your Campaign Tracker spreadsheet
2. Go to Extensions ‚Üí Apps Script
3. Create a new script file and paste this code:

%cfunction doGet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Get data from sheets
  const sessionSheet = ss.getSheetByName('Session Log');
  const npcSheet = ss.getSheetByName('NPC Database');
  const plotSheet = ss.getSheetByName('Plot Thread Tracker');
  const lootSheet = ss.getSheetByName('Loot & Economy');
  
  // Read session data
  const sessionData = sessionSheet.getDataRange().getValues();
  const sessions = sessionData.slice(1, 6).map(row => ({
    number: row[0],
    title: row[2],
    date: row[1],
    xp: row[8]
  })).reverse();
  
  // Read NPC data
  const npcData = npcSheet.getDataRange().getValues();
  const npcs = npcData.slice(1, 11).map(row => ({
    name: row[1],
    role: row[3],
    relationship: row[5],
    avatar: 'üë§'
  }));
  
  // Read quest data
  const plotData = plotSheet.getDataRange().getValues();
  const quests = plotData.slice(1).filter(row => row[4] === 'Active').map(row => ({
    name: row[1],
    status: row[4],
    priority: row[3],
    progress: row[5] || 0
  }));
  
  // Get party gold
  const lootData = lootSheet.getDataRange().getValues();
  const goldRow = lootData[lootData.length - 1];
  const gold = goldRow[7] || 0;
  
  // Calculate totals
  const totalSessions = sessionData.length - 1;
  const totalXP = sessionData.slice(1).reduce((sum, row) => sum + (row[8] || 0), 0);
  
  const result = {
    campaign: {
      name: "Your Campaign Name",
      arc: "Current Arc",
      level: 7,
      sessions: totalSessions
    },
    sessions: sessions,
    npcs: npcs,
    quests: quests,
    gold: gold,
    totalXP: totalXP
  };
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

%c4. Click Deploy ‚Üí New Deployment
5. Choose "Web app"
6. Set "Who has access" to "Anyone"
7. Click Deploy
8. Copy the Web App URL
9. Paste it into the dashboard and click "Connect to Sheet"

%cNeed help? The dashboard will work with sample data until you connect your sheet!
        `, 
        'color: #8b5cf6; font-size: 20px; font-weight: bold;',
        'color: #f1f5f9; font-size: 14px;',
        'color: #22c55e; font-size: 12px; background: #0f172a; padding: 10px; border-radius: 5px; font-family: monospace;',
        'color: #f1f5f9; font-size: 14px;',
        'color: #ec4899; font-size: 14px; font-weight: bold;'
        );
    </script>
</body>
</html>